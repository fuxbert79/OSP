services:
  open-webui:
    image: ghcr.io/open-webui/open-webui:v0.6.43
    container_name: open-webui
    restart: always
    ports:
      - "3000:8080"
    volumes:
      - osp-open-webui-data:/app/backend/data
      - /opt/osp/documents:/app/backend/data/docs
      - /opt/osp/pipelines:/app/backend/data/pipelines
      - /opt/osp/lookups:/app/backend/data/lookups
      - /opt/osp/cache/huggingface:/root/.cache/huggingface
      - /opt/osp/cache/torch:/root/.cache/torch
      - /opt/osp/cache/sentence_transformers:/root/.cache/torch/sentence_transformers
    environment:
      - WEBUI_NAME=OSP Schneider Kabelsatzbau
      - ENABLE_SIGNUP=false
      - DEFAULT_LOCALE=de-DE
      - CHROMA_HTTP_HOST=chromadb
      - CHROMA_HTTP_PORT=8000
      - DOCS_DIR=/app/backend/data/docs
      - USE_EMBEDDING_MODEL_DOCKER=intfloat/multilingual-e5-large
      - HF_HOME=/root/.cache/huggingface
      - TRANSFORMERS_CACHE=/root/.cache/huggingface/transformers
      - SENTENCE_TRANSFORMERS_HOME=/root/.cache/torch/sentence_transformers
      - TORCH_HOME=/root/.cache/torch
    depends_on:
      - chromadb
    networks:
      - osp-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  chromadb:
    image: chromadb/chroma:1.3.6
    container_name: chromadb
    restart: always
    ports:
      - "127.0.0.1:8000:8000"
    volumes:
      - osp-chromadb-data:/data
    environment:
      - IS_PERSISTENT=True
      - ANONYMIZED_TELEMETRY=False
      - ALLOW_RESET=False
      - CHROMA_SERVER_HOST=0.0.0.0
      - CHROMA_SERVER_HTTP_PORT=8000
      - PERSIST_DIRECTORY=/data
    networks:
      - osp-network

  anthropic-proxy:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: anthropic-proxy
    hostname: anthropic-proxy
    restart: unless-stopped
    ports:
      - "127.0.0.1:4000:4000"
    volumes:
      - ./litellm_config.yaml:/app/config.yaml:ro
    env_file:
      - .env
    environment:
      - LITELLM_MASTER_KEY=sk-osp-litellm-master
    command: --config /app/config.yaml --port 4000
    networks:
      - osp-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:4000/', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    mem_limit: 1g

  n8n:
    image: docker.n8n.io/n8nio/n8n:latest
    container_name: n8n
    restart: always
    ports:
      - "127.0.0.1:5678:5678"
    volumes:
      - osp-n8n-data:/home/node/.n8n
    environment:
      - N8N_HOST=n8n.schneider-kabelsatzbau.de
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=https://n8n.schneider-kabelsatzbau.de/
      - GENERIC_TIMEZONE=Europe/Berlin
    networks:
      - osp-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:5678/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  osp-open-webui-data:
    external: true
  osp-chromadb-data:
    external: true
  osp-n8n-data:
    external: true

networks:
  osp-network:
    external: true
