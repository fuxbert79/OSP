services:
  open-webui:
    image: ghcr.io/open-webui/open-webui:v0.7.2
    container_name: open-webui
    restart: always
    ports:
      - "3000:8080"
    volumes:
      - osp-open-webui-data:/app/backend/data
      - /opt/osp/documents:/app/backend/data/docs
      - /opt/osp/pipelines:/app/backend/data/pipelines
      - /opt/osp/lookups:/app/backend/data/lookups
      - /opt/osp/cache/huggingface:/root/.cache/huggingface
      - /opt/osp/cache/torch:/root/.cache/torch
      - /opt/osp/cache/sentence_transformers:/root/.cache/torch/sentence_transformers
    environment:
      - WEBUI_NAME=OSP Schneider Kabelsatzbau
      - ENABLE_SIGNUP=false
      - DEFAULT_LOCALE=de-DE
      - WEBUI_SECRET_KEY=36ef8c284846ef5df1b02a42411a6dc704ef9e873db64ed1d4e148f7ab2a119a
      - CHROMA_HTTP_HOST=chromadb
      - CHROMA_HTTP_PORT=8000
      - DOCS_DIR=/app/backend/data/docs
      - USE_EMBEDDING_MODEL_DOCKER=intfloat/multilingual-e5-large
      - HF_HOME=/root/.cache/huggingface
      - TRANSFORMERS_CACHE=/root/.cache/huggingface/transformers
      - SENTENCE_TRANSFORMERS_HOME=/root/.cache/torch/sentence_transformers
      - TORCH_HOME=/root/.cache/torch
    depends_on:
      - chromadb
    networks:
      - osp-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  chromadb:
    image: chromadb/chroma:1.4.0
    container_name: chromadb
    restart: always
    ports:
      - "127.0.0.1:8000:8000"
    volumes:
      - osp-chromadb-data:/data
    environment:
      - IS_PERSISTENT=True
      - ANONYMIZED_TELEMETRY=False
      - ALLOW_RESET=False
      - CHROMA_SERVER_HOST=0.0.0.0
      - CHROMA_SERVER_HTTP_PORT=8000
      - PERSIST_DIRECTORY=/data
    networks:
      - osp-network

  anthropic-proxy:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: anthropic-proxy
    hostname: anthropic-proxy
    restart: unless-stopped
    ports:
      - "127.0.0.1:4000:4000"
    volumes:
      - ./litellm_config.yaml:/app/config.yaml:ro
    env_file:
      - .env
    environment:
      - LITELLM_MASTER_KEY=sk-osp-litellm-master
    command: --config /app/config.yaml --port 4000
    networks:
      - osp-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:4000/', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    mem_limit: 1g

  n8n:
    image: docker.n8n.io/n8nio/n8n:latest
    container_name: n8n
    restart: always
    ports:
      - "127.0.0.1:5678:5678"
    volumes:
      - osp-n8n-data:/home/node/.n8n
      - /opt/osp/nza/formulare:/home/node/formulare:ro
    environment:
      - N8N_HOST=n8n.schneider-kabelsatzbau.de
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=https://n8n.schneider-kabelsatzbau.de/
      - GENERIC_TIMEZONE=Europe/Berlin
      # Erlaube $env Zugriff in Expressions
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false
      # NZA SharePoint IDs
      - NZA_SITE_ID=rainerschneiderkabelsatz.sharepoint.com,2a90f256-47e6-4ad1-b0d8-341026f63dc3,83b8240d-ea97-48ed-9d46-b510152e29f9
      - NZA_KPL_LIST_ID=7bea980d-9a33-4db5-a844-5c5401872e20
      - NZA_MITARBEITER_LIST_ID=d6dbfa5c-08b3-4bef-bc4a-e840f254935b
      - NZA_CONFIG_LIST_ID=6e56d7d5-c018-4948-a519-96230e5919bf
      - NZA_MASSNAHMEN_LIST_ID=d59ef6e6-428f-4346-a6e2-9524d61c14bc
      - NZA_BILDER_LIST_ID=60847793-da02-4e12-ad0f-052d6157b51e
      # NZA Document Library (SharePoint Drive)
      - NZA_DOCS_DRIVE_ID=72aba5bf-c7e9-415b-aa0e-7d417a469724
    networks:
      - osp-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:5678/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  osp-open-webui-data:
    external: true
  osp-chromadb-data:
    external: true
  osp-n8n-data:
    external: true

networks:
  osp-network:
    external: true
